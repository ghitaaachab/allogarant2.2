<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div>
      <h3>Admin Dashboard</h3>
    </div>

    <div class="form-group">
      <input type="text" id="search-input" class="form-control" placeholder="Search users...">
    </div>

    <div class="users_list">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Inscrit le</th>
            <th scope="col">Client</th>
            <th scope="col">Email</th>
            <th scope="col">Besoin</th>
            <th scope="col">Ville</th>
            <th scope="col">Budget</th>
            <th scope="col">Indicatif</th>
            <th scope="col">Téléphone</th>
            <th scope="col">Step</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody id="users-table-body">
          <% @users.each do |user| %>
            <tr data-user-id="<%= user.id %>">
              <td><%= user.created_at.strftime("%d/%m/%Y") %></td>
              <td><%= "#{user.first_name} #{user.last_name}" %></td>
              <td><%= user.email %></td>
              <td><%= user.need %></td>
              <td><%= user.city %></td>
              <td><%= user.budget %></td>
              <td><%= user.indicatif %></td>
              <td><%= user.phone %></td>
              <td>
                <select class="form-control step-select" data-user-id="<%= user.id %>">
                  <option value="not interesed" <%= 'selected' if user.step == 'not intersted' %>>Not interested</option>
                  <option value="to call" <%= 'selected' if user.step == 'to call' %>>To call</option>
                  <option value="to call back" <%= 'selected' if user.step == 'to call back' %>>To call back</option>
                  <option value="no response" <%= 'selected' if user.step == 'no response' %>>No response</option>
                  <option value="done deal" <%= 'selected' if user.step == 'done deal' %>>Done deal</option>
                  <option value="hesitate" <%= 'selected' if user.step == 'hesitate' %>>Hesitate</option>
                  <option value="already found" <%= 'selected' if user.step == 'already found' %>>Already found</option>
                </select>
              </td>
              <td> <!-- Added delete button -->
                <button class="btn btn-danger delete-btn" data-user-id="<%= user.id %>">Delete</button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>

    document.addEventListener('DOMContentLoaded', function() {
  const tableBody = document.getElementById('users-table-body');

  tableBody.addEventListener('click', function(event) {
    if (event.target.classList.contains('delete-btn')) {
      const row = event.target.closest('tr');
      const userId = row.getAttribute('data-user-id');

      if (confirm('Are you sure you want to delete this user?')) {
        $.ajax({
          url: '/admin/delete_user/' + userId,
          type: 'PATCH',
          data: {
            authenticity_token: '<%= form_authenticity_token %>'
          },
          success: function(response) {
            row.remove();
            console.log('User deleted successfully');
          },
          error: function(response) {
            console.error('Error deleting user');
          }
        });
      }
    }
  });
});

    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('search-input');
      const tableBody = document.getElementById('users-table-body');

      searchInput.addEventListener('keyup', function() {
        const searchTerm = searchInput.value.toLowerCase();
        const rows = tableBody.getElementsByTagName('tr');

        Array.from(rows).forEach(function(row) {
          const clientCell = row.getElementsByTagName('td')[1];
          if (clientCell) {
            const clientText = clientCell.textContent || clientCell.innerText;
            if (clientText.toLowerCase().includes(searchTerm) || clientText.toLowerCase().startsWith(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          }
        });
      });

      const stepSelects = document.querySelectorAll('.step-select');
      stepSelects.forEach(function(select) {
        select.addEventListener('change', function() {
          const userId = select.getAttribute('data-user-id');
          const step = select.value;

          $.ajax({
            url: '/admin',
            type: 'POST',
            data: {
              user: {
                id: userId,
                step: step
              },
              authenticity_token: '<%= form_authenticity_token %>'
            },
            success: function(response) {
              console.log('Step updated successfully');
            },
            error: function(response) {
              console.error('Error updating step');
            }
          });
        });
      });
    });
  </script>
</body>
</html>
